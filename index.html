<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Chatbot Project</title>
   
    <script src="https://cdn.tailwindcss.com"></script>
  
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap');
        body { font-family: 'Inter', sans-serif; }
    
        #chat-area::-webkit-scrollbar { width: 6px; }
        #chat-area::-webkit-scrollbar-thumb { background-color: #d1d5db; border-radius: 3px; }
    </style>
</head>
<body class="bg-gray-100 min-h-screen flex items-center justify-center p-4">

   
    <div class="w-full max-w-2xl bg-white rounded-lg shadow-xl flex flex-col h-[80vh] min-h-[500px]">
        
      
        <header class="p-4 border-b flex justify-between items-center bg-gray-50 rounded-t-lg">
            <h1 class="text-xl font-semibold text-gray-800">Ai chat bot</h1>
            
        </header>

       
        <main id="chat-area" class="flex-grow p-4 overflow-y-auto space-y-4 custom-scrollbar">
            <div id="initial-message" class="text-center p-8 text-gray-500 italic">
                Loading chat history from your browser...
            </div>
        </main>

      
        <div id="error-box" class="hidden p-3 mx-4 my-2 text-sm font-medium text-red-700 bg-red-100 rounded-lg shadow-inner"></div>

      
        <footer class="p-4 border-t bg-gray-50 rounded-b-lg">
            <form id="message-form" class="flex space-x-3">
                <input
                    type="text"
                    id="message-input"
                    placeholder="Type a message..."
                    class="flex-grow p-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-indigo-500"
                    required
                >
                <button
                    type="submit"
                    id="send-button"
                    class="px-4 py-2 bg-indigo-600 text-white font-semibold rounded-lg hover:bg-indigo-700 transition duration-150 disabled:bg-indigo-400"
                >
                    Send
                </button>
            </form>
        </footer>
    </div>

  
    <script type="module">
        
        const CHAT_STORAGE_KEY = 'chatbot_history';
       
        const API_BASE_URL = "https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent";
        
        const API_KEY = "AIzaSyATbPr8g4k71aQgNrRLxYDLh_e6pKVf4FM"; 
        
        const SYSTEM_INSTRUCTION = "You are an 'Ai Chatbot', a straightforward and concise AI designed to help the user organize their thoughts. Keep responses short and action-oriented. Do not use complex language or refer to yourself as an AI or model.";
        
        
        const chatArea = document.getElementById('chat-area');
        const messageForm = document.getElementById('message-form');
        const messageInput = document.getElementById('message-input');
        const sendButton = document.getElementById('send-button');
        const errorBox = document.getElementById('error-box');
        const initialMessage = document.getElementById('initial-message');

        let isProcessing = false;

       
        function displayError(message) {
            errorBox.textContent = `Error: ${message}`;
            errorBox.classList.remove('hidden');
            console.error(message);
        }

       
        function clearError() {
            errorBox.classList.add('hidden');
            errorBox.textContent = '';
        }

        
        const delay = ms => new Promise(resolve => setTimeout(resolve, ms));

       
        function renderMessage(message) {
            
            let textContent = message.text.replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>');
            textContent = textContent.replace(/\n/g, '<br/>');

            const isUser = message.sender === 'user';
            
            const timestampDate = new Date(message.timestamp || Date.now());
            const timestamp = timestampDate.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });

            const messageDiv = document.createElement('div');
            messageDiv.className = `flex ${isUser ? 'justify-end' : 'justify-start'}`;

            const bubble = document.createElement('div');
            bubble.className = `max-w-xs px-4 py-3 rounded-xl shadow-md text-sm ${
                isUser 
                ? 'bg-indigo-600 text-white rounded-br-none' 
                : 'bg-gray-200 text-gray-800 rounded-tl-none'
            }`;
            
            bubble.innerHTML = `
                <p>${textContent}</p>
                <span class="block text-right pt-2 text-xs opacity-70">${timestamp}</span>
            `;

            const avatar = document.createElement('div');
            avatar.className = `w-8 h-8 rounded-full flex items-center justify-center font-bold text-lg ${
                isUser 
                ? 'bg-indigo-100 text-indigo-700 ml-2 order-2' 
                : 'bg-green-100 text-green-700 mr-2 order-1'
            }`;
            avatar.textContent = isUser ? 'U' : 'C';

            messageDiv.appendChild(isUser ? bubble : avatar);
            messageDiv.appendChild(isUser ? avatar : bubble);

            chatArea.appendChild(messageDiv);
        }

     
        function scrollToBottom() {
            chatArea.scrollTop = chatArea.scrollHeight;
        }

        
        function loadHistory() {
            try {
                const storedHistory = localStorage.getItem(CHAT_STORAGE_KEY);
                const chatHistory = storedHistory ? JSON.parse(storedHistory) : [];

                chatArea.innerHTML = ''; 

                if (chatHistory.length === 0) {
                     initialMessage.textContent = 'Welcome! Start chatting with Ai chat bot! Your history will be saved here.';
                     chatArea.appendChild(initialMessage);
                } else {
                    chatHistory.forEach(renderMessage);
                }
                
                messageInput.disabled = false;
                sendButton.disabled = false;
                scrollToBottom();

            } catch (e) {
                displayError("Failed to load chat history from local storage.");
                console.error("Local Storage Load Error:", e);
            }
        }

    
        async function callGeminiApi(conversationHistory) {
            
            const filteredHistory = conversationHistory.filter(msg => msg.text && msg.sender);
            
            const chatHistory = filteredHistory.map(msg => ({
                role: msg.sender === 'user' ? 'user' : 'model',
                parts: [{ text: msg.text }]
            }));
        
            const payload = {
                contents: chatHistory,
                systemInstruction: { parts: [{ text: SYSTEM_INSTRUCTION }] },
                config: {
                    maxOutputTokens: 2048,
                    temperature: 0.7,
                }
            };
        
            let response = null;
            let attempts = 0;
            const maxRetries = 5;
        
            while (attempts < maxRetries) {
                try {
              
                    const fetchUrl = `${API_BASE_URL}?key=${API_KEY}`;
                    const fetchResponse = await fetch(fetchUrl, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(payload)
                    });
        
                    if (!fetchResponse.ok) {
                        throw new Error(`HTTP error! status: ${fetchResponse.status}`);
                    }
        
                    response = await fetchResponse.json();
                    break; 
                } catch (e) {
                    attempts++;
                    if (attempts < maxRetries) {
                        const backoffTime = Math.pow(2, attempts) * 1000;
                        await delay(backoffTime);
                    } else {
                        console.error("failed after multiple retries:", e);
                        throw new Error("Could not connect to AI. Please try again later.");
                    }
                }
            }
            
            const text = response?.candidates?.[0]?.content?.parts?.[0]?.text;
            if (!text) {
                throw new Error("Received an empty response from the AI.");
            }
            return text;
        }

      
        async function sendMessage(e) {
            e.preventDefault();
            const userMessageText = messageInput.value.trim();
            if (isProcessing || userMessageText === '') return;

            messageInput.value = '';
            
            clearError();
            isProcessing = true;
            sendButton.disabled = true;
            messageInput.disabled = true;

            const timestamp = new Date().toISOString();

            const userMessageData = {
                text: userMessageText,
                sender: 'user',
                timestamp: timestamp,
            };
            
            let chatHistory = [];
            try {
                const storedHistory = localStorage.getItem(CHAT_STORAGE_KEY);
                chatHistory = storedHistory ? JSON.parse(storedHistory) : [];
            } catch(e) {
                console.error("Error parsing chat history:", e);
            }
            
            
            chatHistory.push(userMessageData);
            localStorage.setItem(CHAT_STORAGE_KEY, JSON.stringify(chatHistory));
            renderMessage(userMessageData);

            
            if (initialMessage && initialMessage.parentNode) {
                initialMessage.remove();
            }
            renderLoadingMessage();
            scrollToBottom();
            
            try {
                
                const aiResponseText = await callGeminiApi(chatHistory);

                
                removeLoadingMessage();
          
                
                const aiMessageData = {
                    text: aiResponseText,
                    sender: 'coach',
                    timestamp: new Date().toISOString(),
                };
                
                chatHistory.push(aiMessageData);
                localStorage.setItem(CHAT_STORAGE_KEY, JSON.stringify(chatHistory));
                renderMessage(aiMessageData);


            } catch (e) {
                removeLoadingMessage();
                displayError(e.message || "An unexpected error occurred during message send.");
            } finally {
                isProcessing = false;
                sendButton.disabled = false;
                messageInput.disabled = false;
                messageInput.focus();
                scrollToBottom();
            }
        }

        
        function renderLoadingMessage() {
            const loadingDiv = document.createElement('div');
            loadingDiv.id = 'loading-coach-message';
            loadingDiv.className = 'flex justify-start';
            loadingDiv.innerHTML = `
                <div class="w-8 h-8 rounded-full bg-green-100 flex items-center justify-center text-green-700 mr-2 order-1 font-bold text-lg">C</div>
                <div class="bg-gray-200 px-4 py-3 rounded-xl rounded-tl-none shadow-md order-2">
                    <div class="animate-pulse flex space-x-2">
                        <div class="h-2 w-2 bg-gray-400 rounded-full"></div>
                        <div class="h-2 w-2 bg-gray-400 rounded-full"></div>
                        <div class="h-2 w-2 bg-gray-400 rounded-full"></div>
                    </div>
                </div>
            `;
            chatArea.appendChild(loadingDiv);
        }

        function removeLoadingMessage() {
            const loadingDiv = document.getElementById('loading-coach-message');
            if (loadingDiv) {
                loadingDiv.remove();
            }
        }
        
        

        window.onload = loadHistory; 

        messageForm.addEventListener('submit', sendMessage);

    </script>
</body>
</html>
